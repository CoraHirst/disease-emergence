---
title: "Vaccination Efficacy for Zoonoses with Varying Spillover $R_0$"
subtitle: "Recapitulating the results of Antia 2003"
format: pdf
execute:
  echo: false
  warning: false
bibliography: ../../../assets/bibFiles/dataanalysis-references.bib
csl: ../../../assets/bibFiles/apa.csl
---

```{r setup}
# load libraries 
library(ggplot2) #for plotting
library(here) #for easy local path referencing
library(tidyverse) #for easy manipulation of data structures
library(nleqslv) #for solving nonlinear systems of equations


```

# Objective

The goal of this document is to develop a multi-type branching process model to investigate the impact of vaccination on the probability of emergence of emergence of a zoonotic disease in a population. 

In this document, we will consider the simplest case of pathogen evolution, where the pathogen is a single mutation away from evolving an $R_0 >= 1$, which is sufficient for the pathogen to achieve sustained human-human transmission. 

# Model outline

We base the following on a model presented in @AntiaNature2003, which predicts the probability of disease emergence for Zoonotic variants as a function of their abilities to transmit after spillover (inital $R_0$), rates of of mutation, and mutational distance (number of mutations) from an $R_0 >= 1$. 

Predictions are made by calculating the extinction probabilities of chains of transmission initiated by a spillover variant using a multi-type branching process framework. 

For a better understanding of this model, please refer to `code/exploratory/AntiaNat2003_models.qmd`. 

# Effect of population immunity on emergence probability 

We adapt the above model to observe how the probability of emergence changes as a function of the fraction of the population immune to infection. We refer to this change in probability as $\Delta P_{emergence}$. 

We first assume that vaccination provides complete immunity, such that 25% vaccinated means a variant is 25% less likely to infect and generate offspring cases as it would be in the unvaccinated population. Ultimately: 

$$
\Delta P_{emergence} = P_{emergence}(R_{0,WT}) - P_{emergence}((1-f_v)R_{0,WT}),
$$ 
where $R_{0,WT}$ is the R_0 of the spillover variant in an unvaccinated population and $f_v$ is the fraction of the population vaccinated.  
In the code chunk below, we show the dependence of the probability of emergence of a variant with various mutation rates, $\mu$ on the probability of emergence: 

```{r changing-mu}
### ## Define fixed point equations
# pgfs - qi
fpeq_1 = function(q1,q2) {exp(-(1-mu)*R0_1*(1-q1))*exp(-mu*R0_1*(1-q2)) - q1}
fpeq_2 = function(q1,q2) {exp(-R0_2*(1-q2)) - q2}

# function for prob.emergence
prob_emergence = function(qs,init) {1 - prod(qs^init)} #we could vectorize this for qs longer than 

## parms 
R0_1s = seq(0,1.2, by = 0.01) #R1s to test
R0_2 = 1.2 # final R0_2
mus = c(10^-1, 10^-2, 10^-3, 10^-4) # mus to test 

# define initial conditions 
start = c(1,0) #start with 1 wild type and no evolved

#empty vector to store probs
probs.emergence = matrix(nrow = length(R0_1s), ncol = length(mus))

## solve system of equations
# define system of nl equations
single_mut <- function(x) {
y <- numeric(2)
y[1] <- fpeq_1(x[1], x[2])
y[2] <- fpeq_2(x[1], x[2])
y
}

# initial guess
xstart = c(0.9, 0.1)
fstart = single_mut(xstart)

for(j in 1:length(mus)){
  #set mu
  mu = mus[j] 
  for(i in 1:length(R0_1s)){
   # set R0_1
    R0_1 = R0_1s[i]
   # newton start
    qs = nleqslv(xstart, single_mut, method="Newton", global="none", control=list(trace=1,stepmax=2))$x
   # solve for prob.emergence
    prob.emergence = prob_emergence(qs = qs, init = start) 
   # add solution to matrix
    probs.emergence[i,j] = prob.emergence
  }
}

### prepare probs.emergence for plotting
# format wide df
probs.emergence = cbind(R0_1s, probs.emergence) %>% as.data.frame() #add R01_s column and format as df
colnames(probs.emergence) = c("R0", as.character(formatC(mus, format = "e", digits = 1))) # add mu to columns

# pivot to longform 
probs.emergence.long = probs.emergence %>%
 pivot_longer(cols = !R0,
  names_to = "mu",
  values_to = "Prob.Emergence"
)

# Plot
## colors for plotting
my.colors = c("black", "red", "forestgreen", "blue")
## plot
ggplot() + 
  geom_line(data = probs.emergence.long, aes(x = R0, y = Prob.Emergence, group = mu, col = mu)) +
  geom_line(data = probs.emergence.long %>% filter(mu == '1.0e-03'), aes(x = R0, y = Prob.Emergence), col = "forestgreen", size = 2) +
  theme_bw() +
  labs(x = "R0 of introduced pathogen", y = "Probability of emergence") +
  scale_y_continuous(trans = "log10") +
  scale_color_manual(values = my.colors)

```

We plot the predicted probabilities of emergence for a variant with $mu = 10^{-3}$ in bold, as we will be considering this curve in the next figure.


```{r deltaP-scheme}

## df of points for initial R0 of 0.8 and f_v of 25%

### plot curve for mu = 10^-3
## plot
ggplot() + 
  geom_line(data = probs.emergence.long %>% filter(mu == '1.0e-03'), aes(x = R0, y = Prob.Emergence), col = "forestgreen", size = 2) +
  theme_bw() +
  labs(x = "R0 of introduced pathogen", y = "Probability of emergence") +
  scale_y_continuous(trans = "log10") 



```

# References